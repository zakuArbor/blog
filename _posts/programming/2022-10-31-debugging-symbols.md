---
layout: post
title: Debugging Symbols - A Basic Look at Separating Debug Symbols
description: A look on how to read debugging symbols not contained in binary
categories: [programming, c/c++, gdb, debug]
---

As a note to myself, I would like to explore how to generate a symbols file but ship to 
the customer a stripped binary lacking of any debugging symbols but still be able to 
debug customer's issue. 

When compiling, developers can enable a debug flag to generate debug information in 
the binary. Debug information is generated by the compiler or assembler to produce 
information that is useful to debuggers such as GDB and retains symbol names (such as 
variable and function names) in the binary. While I am not too familiar with what 
sorts of data is stored in the debug info, having the ability to step through a code 
and have access to the symbol table is what I am going to try to achieve for the purpose
of today's blog post.

## Sample Code

**Gist:** [https://gist.github.com/zakuArbor/a3fcaef1aa2e9a271a8f3bc6c542aa15](https://gist.github.com/zakuArbor/a3fcaef1aa2e9a271a8f3bc6c542aa15)

**Files:**
* cat.c
* goose.c
* main.c

**cat.c**
```c
#include <stdio.h>
void meow() {
    printf("The Cat Meows at its friend\n");
}
```

**goose.c**
```c
#include <stdio.h>
#define PI 3.14
#define Square(x) ((x)*(x))
void honk() {
    double area = PI * Square(9); //area = pi * r^2
    printf("The Goose Honks the area of the circular pond: %.2f m^2\n", area);
}
```

**main.c**
```c
void honk();
void meow();
int main() {
    honk();
    meow();
    return 0;
}
```

## Steps

**1. Compile (no linking)**
```sh
gcc -g -c main.c 
gcc -g -c goose.c
gcc -g -c cat.c
```

**2. Create a static library (optional)**
```sh
ar -rs libanimal.a cat.o goose.o
```

**3. Create debug binary**
```sh
gcc -g main.o -L. -lanimal -o prog-g
```

**4. Create stripped binary (production)**
```sh
cp prog-g prog
objcopy --only-keep-debug prog prog.sym
objcopy --strip-debug prog
```

## Verify binary
Debug builds always are larger in size because it contains extra debugging information and the symbol names are not mangled.

**1.** File Sizes: Debug build should be larger in size

```sh
$ stat --format="%s %n" prog*
24888 prog
26976 prog-g
15600 prog.sym
```

As one can see, the stripped binary is smaller in size because all debugging symbols were removed.
One could go to the extra step and strip all symbols to make the binary even more smaller:

```sh
$ cp prog-g prog-s #will become the completely stripped version
$ strip -s prog-s
$ stat --format="%s %n" prog* | sort
15024 prog-s
15600 prog.sym
24888 prog
26976 prog-g
```

**2.** Symbols: Debug build should contain symbol while production build should have no symbols
<div class = "language-sh highlighter-rouge">
<div class = "highlight">
<pre class = "highlight"><span class="nv">$ </span>objdump -g prog-g | grep honk
    &lt;3b&gt;   DW_AT_name        : (indirect string, offset: 0x4b): <font color="#C01C28"><b>honk</b></font>
    &lt;185&gt;   DW_AT_name        : (indirect string, offset: 0x4b): <font color="#C01C28"><b>honk</b></font>
  0x00000040 3d783836 2d363420 2d670068 6f6e6b00 =x86-64 -g.<font color="#C01C28"><b>honk</b></font>.
<span class="nv">$ </span>objdump -g prog | grep honk
<span class="nv">$ </span>objdump -g prog-s | grep honk
</pre></div></div>

As expected, only the debugged version contains the symbol `honk` in the binary.

**3.** GDB

As debug information was stripped from the executable, one should not see any source code as seen below:
```
$ gdb prog --silent
Reading symbols from prog...

This GDB supports auto-downloading debuginfo from the following URLs:
https://debuginfod.fedoraproject.org/ 
Enable debuginfod for this session? (y or [n]) n
Debuginfod has been disabled.
To make this setting permanent, add 'set debuginfod enabled off' to .gdbinit.
(No debugging symbols found in prog)
(gdb) list main
No symbol table is loaded.  Use the "file" command.
```

## Add Debug Symbols to Non-Debug Builds

To create a non-debug build, we removed the symbols from the binary. Before we removed the symbols, 
we stored them in a symbol file. We can utilize this symbol file to add debug information back to 
the non-debug build as seen below:

<div class = "language-sh highlighter-rouge">
<div class = "highlight">
<pre class = "highlight"><span class="nv">$ </span>objcopy --add-gnu-debuglink=prog.sym prog
<span class="nv">$ </span>gdb prog --silent
Reading symbols from <font color="#26A269">prog</font>...
Reading symbols from <font color="#26A269">/home/zaku/Documents/projects/blog/assets/code/lib-static-shared/prog.sym</font>...
(gdb) list main
1	<font color="#26A269">void</font> <b>honk</b><font color="#C01C28">();</font>
2	<font color="#26A269">void</font> <b>meow</b><font color="#C01C28">();</font>
3	<font color="#26A269">int</font> <b>main</b><font color="#C01C28">()</font> <font color="#C01C28">{</font>
4	    <b>honk</b><font color="#C01C28">();</font>
5	    <b>meow</b><font color="#C01C28">();</font>
6	    <font color="#12488B"><b>return</b></font> <font color="#A347BA">0</font><font color="#C01C28">;</font>
7	<font color="#C01C28">}</font>
(gdb) list honk
1	<font color="#12488B"><b>#include</b></font> <font color="#C01C28">&lt;stdio.h&gt;</font>
2	<font color="#12488B"><b>#define</b></font> PI <font color="#A347BA">3.14</font>
3	<font color="#12488B"><b>#define</b></font> <b>Square</b><font color="#C01C28">(</font>x<font color="#C01C28">)</font> <font color="#C01C28">((</font>x<font color="#C01C28">)*(</font>x<font color="#C01C28">))</font>
4	<font color="#26A269">void</font> <b>honk</b><font color="#C01C28">()</font> <font color="#C01C28">{</font>
5	    <font color="#26A269">double</font> area <font color="#C01C28">=</font> PI <font color="#C01C28">*</font> <b>Square</b><font color="#C01C28">(</font><font color="#A347BA">9</font><font color="#C01C28">);</font> <font color="#2AA1B3">//area = pi * r^2</font>
6	    <b>printf</b><font color="#C01C28">(&quot;The Goose Honks the area of the circular pond: %.2f m^2</font><font color="#A347BA">\n</font><font color="#C01C28">&quot;,</font> area<font color="#C01C28">);</font>
7	<font color="#C01C28">}</font>
(gdb) 
</pre>
</div></div>

The same can be done to the binary that was entirely stripped of all symbols (**prog-s**).

## Summary
To create a debug and non-debug build, do the following:
1. Compile with debug flag (`gcc -g file.c -o file-g)
2. Create stripped binary
```sh
cp prog-g prog
objcopy --only-keep-debug prog prog.sym
objcopy --strip-debug prog
```
2.5 Strip all symbols (optional)
```sh
strip -s prog
```
3. Recover debugging symbols
```
objcopy --add-gnu-debuglink=prog.sym prog
```

Here's a gif using `asciinema` and `agg`:
![A gif demonstration](../assets/programming/gif/debug-symbols-demo.gif)

